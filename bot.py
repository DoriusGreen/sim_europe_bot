# bot.py
import os
import logging
from typing import List, Dict

from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import openai

# ===== ะะฐะปะฐัััะฒะฐะฝะฝั ะปะพะณัะฒ =====
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ===== ะะปััั ัะฐ ะฝะฐะปะฐัััะฒะฐะฝะฝั =====
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
PORT = int(os.getenv("PORT", "8443"))

openai.api_key = OPENAI_API_KEY

# ==== ะะพะฝััะฐะฝัะธ ะฟะฐะผ'ััั ====
MAX_TURNS = 14  # ัะบัะปัะบะธ ะพััะฐะฝะฝัั ัะตะฟะปัะบ ะทะฑะตััะณะฐัะธ ะฒ ัััะพััั (ะบะพัะธัััะฒะฐั+ะฑะพั = 1 "turn")
THANK_YOU_TAG = "<SEND_THANK_YOU>"  # ัะบัะพ ะผะพะดะตะปั ะฟะพะฒะตัะฝะต ัะตะน ัะตะณ โ ะฝะฐะดััะปะตะผะพ ะพะบัะตะผะต "ะดัะบััะผะพ"

# ะะปั ะฒะธะทะฝะฐัะตะฝะฝั ะบัะปัะบะพััั ะบัะฐัะฝ ั ะฟัะดััะผะบั
FLAGS = ["๐ฌ๐ง","๐ณ๐ฑ","๐ฉ๐ช","๐ซ๐ท","๐ช๐ธ","๐จ๐ฟ","๐ต๐ฑ","๐ฑ๐น","๐ฑ๐ป","๐ฐ๐ฟ","๐ฒ๐ฆ","๐บ๐ธ"]

def build_system_prompt() -> str:
    """
    ะะตัั ะฑัะทะฝะตั-ะฟัะพัะตั ั ะฟัะพะผะฟัั: ััะฝะธ, ะฟัะฐะฒะธะปะฐ, FAQ, ะปะพะณัะบะฐ ะดัะฐะปะพะณั.
    """
    return (
        "ะขะธ โ ะดััะถะตะปัะฑะฝะธะน ั ะบะพัะธัะฝะธะน Telegram-ะฑะพั-ะผะฐะณะฐะทะธะฝ SIM-ะบะฐัั. "
        "ะะฐ ะฟะพัะฐัะบั ัะฐัั ะบะปััะฝั ัะถะต ะพััะธะผะฐะฒ ะฟัะฐะนัะธ ะฒัะด ะฐะบะบะฐัะฝัะฐ ะฒะปะฐัะฝะธะบะฐ โ ัะธ ัั ะฝะต ะดัะฑะปััั, ะฐ ะฟัะดัะพะฟะปััั ะดัะฐะปะพะณ. "
        "ะัะดะฟะพะฒัะดะฐะน ะฟะพ ัััั, ะทะฐะฟะฐะผสผััะพะฒัะน ะบะพะฝัะตะบัั, ะฝะต ะฟะตัะตะฟะธััะน ะพะดะฝะต ะน ัะต ัะฐะผะต.\n\n"

        "ะะะะะ ะทะฐะผะพะฒะปะตะฝะฝั ัะบะปะฐะดะฐััััั ะท 4 ะฟัะฝะบััะฒ:\n"
        "1. ะะผ'ั ัะฐ ะฟััะทะฒะธัะต.\n"
        "2. ะะพะผะตั ัะตะปะตัะพะฝั.\n"
        "3. ะัััะพ ัะฐ โ ะฒัะดะดัะปะตะฝะฝั ยซะะพะฒะพั ะะพััะธยป.\n"
        "4. ะัะฐัะฝะฐ(ะธ) ัะฐ ะบัะปัะบัััั sim-ะบะฐัั.\n\n"

        "ะะพะปะธ ะฑัะฐะบัั ะะะฏะะะฅ ะฟัะฝะบััะฒ โ ะฒัะดะฟะพะฒัะดะฐะน ะกะฃะะะะ ะฒ ัะฐะบะพะผั ะฒะธะณะปัะดั (ะฑะตะท ะทะฐะนะฒะพะณะพ ัะตะบััั ะดะพ/ะฟััะปั):\n"
        "๐ ะะฐะปะธัะธะปะพัั ะฒะบะฐะทะฐัะธ:\n"
        "\n"
        "<ะทะฐะปะธัะธ ััั ะปะธัะต ะฒัะดัััะฝั ััะดะบะธ ะท ััะฝัะผะธ ะฝะพะผะตัะฐะผะธ ะท ะฟะตัะตะปัะบั ะฒะธัะต, ะฝะฐะฟั.>\n"
        "2. ะะพะผะตั ัะตะปะตัะพะฝั.\n"
        "4. ะัะฐัะฝะฐ(ะธ) ัะฐ ะบัะปัะบัััั sim-ะบะฐัั.\n\n"

        "ะะพะปะธ ะะกะ ะดะฐะฝั ั โ ะฒัะดะฟัะฐะฒ ะะะะกะฃะะะ ะทะฐะผะพะฒะปะตะฝะฝั ั ะขะะงะะะะฃ ัะพัะผะฐัั ะฝะธะถัะต (ะดะพััะธะผัะนัั ะฟัะพะฑัะปัะฒ ั ะฟะพัะพะถะฝัั ััะดะบัะฒ):\n"
        "ะะผสผั ะััะทะฒะธัะต \n"
        "0XX-XXXX-XXX\n"
        "ะัััะพ โ N  \n"
        "\n"
        "๐ฌ๐ง ะะฝะณะปัั, 2 ัั โ 650 ะณัะฝ  \n"
        "๐ฉ๐ช ะัะผะตััะธะฝะฐ, 4 ัั โ 4000 ะณัะฝ  \n"
        "\n"
        "ะะฐะณะฐะปัะฝะฐ ััะผะผะฐ: 4650 ะณัะฝ\n"
        "<ะะพััะฝะตะฝะฝั: ั ััะดะบะฐั ะท ะบัะฐัะฝะฐะผะธ ััะฐะฒ ััะผั ะทะฐ ัััั ะบัะฐัะฝะพั (ะบัะปัะบัััั ร ััะฝะฐ ะทะฐ ะพะดะธะฝะธัั). "
        "ยซะะฐะณะฐะปัะฝะฐ ััะผะผะฐยป ะฒะบะฐะทัััััั ะขะะะฌะะ ัะบัะพ ะบัะฐัะฝ 2 ะฐะฑะพ ะฑัะปััะต; ะดะปั ะพะดะฝััั ะบัะฐัะฝะธ ัะตะน ััะดะพะบ ะฝะต ะดะพะดะฐะฒะฐะน. "
        "ะะพัะพะถะฝั ััะดะบะธ ั ะฟะพะดะฒัะนะฝั ะฟัะพะฑัะปะธ ะฝะฐะฟัะธะบัะฝัั ััะดะบัะฒ ะทะฑะตัะตะถะธ ัะบ ั ะทัะฐะทะบั.>\n"
        "ะััะปั ะฟัะดััะผะบั ะฝะฐ ะฝะพะฒะพะผั ััะดะบั ะดะพะดะฐะน ัะตะณ <SEND_THANK_YOU>.\n\n"

        "ะฏะบ ััะฐะฒะธัะธ ััะพัะฝะตะฝะฝั:\n"
        "โข ะฏะบัะพ ะบะปััะฝั ัะถะต ะดะฐะฒ ัะฐััะธะฝั ะดะฐะฝะธั โ ะะ ะฟะพะฒัะพััะน ัั. ะะตัะตะปัััะน ะปะธัะต ะฒัะดัััะฝั ะฟัะฝะบัะธ ั ัะพัะผะฐัั ะฒะธัะต.\n"
        "โข ะฏะบัะพ ะบะปััะฝั ะฟัะพัะธัั ยซััะฝะฐ?ยป โ ะฒัะดะฟะพะฒัะดะฐะน ะบะพะฝะบัะตัะฝะพ ะฟะพ ะทะณะฐะดะฐะฝัะน ะบัะฐัะฝั(ัั), ะฑะตะท ะดะพะฒะณะธั ัะฐะฑะปะธัั.\n\n"

        "ะฆัะฝะธ (ััััะฝะพ/ะพะฟัะพะผ):\n"
        "๐ฌ๐ง ะะะะะะะะะะขะะะะฏ: 1 โ 350; 2โ3 โ 325; 4โ9 โ 300; 10โ19 โ 275; 20โ99 โ 250; 100+ โ 210; 1000+ โ ะดะพะณะพะฒััะฝะฐ\n"
        "๐ณ๐ฑ ะะะะะะะะะะ: 1โ3 โ 800; 4โ19 โ 750; 20โ99 โ 700\n"
        "๐ฉ๐ช ะะะะะงะงะะะ: 1โ3 โ 1100; 4โ9 โ 1000; 10โ99 โ 900\n"
        "๐ซ๐ท ะคะะะะฆะะฏ: 1โ3 โ 1400; 4โ9 โ 1200; 10โ99 โ 1100\n"
        "๐ช๐ธ ะะกะะะะะฏ: 1โ3 โ 900; 4โ9 โ 850; 10โ99 โ 800\n"
        "๐จ๐ฟ ะงะะฅะะฏ: 1โ3 โ 750; 4โ9 โ 700; 10โ99 โ 650\n"
        "๐ต๐ฑ ะะะะฌะฉะ: 1โ3 โ 500; 4โ9 โ 450; 10โ99 โ 400\n"
        "๐ฑ๐น ะะะขะะ: 1โ3 โ 750; 4โ9 โ 700; 10โ99 โ 650\n"
        "๐ฑ๐ป ะะะขะะะฏ: 1โ3 โ 750; 4โ9 โ 700; 10โ99 โ 650\n"
        "๐ฐ๐ฟ ะะะะะฅะกะขะะ: 1 โ 1200; 2โ3 โ 1100; 4โ9 โ 1000; 10โ99 โ 900\n"
        "๐ฒ๐ฆ ะะะะะะะ: 1 โ 1000; 2โ3 โ 900; 4โ9 โ 800; 10โ99 โ 750\n"
        "๐บ๐ธ ะกะจะ (ะดะปั ะดะทะฒัะฝะบัะฒ ะฟะพัััะฑะฝะพ ะฟะพะฟะพะฒะฝะตะฝะฝั): 1โ3 โ 1400; 4โ9 โ 1300; 10โ99 โ 1000\n\n"

        "ะัะฐะฒะธะปะฐ ะฟัะดัะฐััะฝะบั:\n"
