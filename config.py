import os
from typing import Set, Tuple, Optional

# ===== ÐšÐ»ÑŽÑ‡Ñ– Ñ‚Ð° Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ =====
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
PORT = int(os.getenv("PORT", "8443"))

# ==== ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ð¸ Ð¿Ð°Ð¼'ÑÑ‚Ñ–/Ð¼Ñ–Ñ‚Ð¾Ðº ====
MAX_TURNS = 10
ORDER_DUP_WINDOW_SEC = 20 * 60  # 20 Ñ…Ð²Ð¸Ð»Ð¸Ð½

# ==== Ð“Ð Ð£ÐŸÐ Ð”Ð›Ð¯ Ð—ÐÐœÐžÐ’Ð›Ð•ÐÐ¬ ====
ORDER_FORWARD_CHAT_ID = int(os.getenv("ORDER_FORWARD_CHAT_ID", "-1003062477534"))

# ==== ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð¸ ====
def _parse_ids(env: Optional[str]) -> Set[int]:
    out: Set[int] = set()
    if not env: return out
    for x in env.split(","):
        try:
            if x.strip(): out.add(int(x.strip()))
        except ValueError: pass
    return out

def _parse_usernames(env: Optional[str]) -> Set[str]:
    out: Set[str] = set()
    if not env: return out
    for x in env.split(","):
        x = x.strip().lstrip("@").lower()
        if x: out.add(x)
    return out

DEFAULT_OWNER_USERNAME = os.getenv("OWNER_USERNAME", "Sim_Card_Three")
DEFAULT_OWNER_USER_ID = os.getenv("OWNER_USER_ID", "")

MANAGER_USER_IDS = _parse_ids(os.getenv("MANAGER_USER_IDS"))
if DEFAULT_OWNER_USER_ID:
    MANAGER_USER_IDS |= _parse_ids(DEFAULT_OWNER_USER_ID)

MANAGER_USERNAMES = _parse_usernames(os.getenv("MANAGER_USERNAMES"))
if DEFAULT_OWNER_USERNAME:
    MANAGER_USERNAMES.add(DEFAULT_OWNER_USERNAME.strip().lstrip("@").lower())

# ==== ÐŸÑ€Ð°Ð¹ÑÐ¸ Ð¹ Ð¼Ð°Ð¿Ð¸ ÐºÑ€Ð°Ñ—Ð½ ====
PRICE_TIERS = {
    "Ð’Ð•Ð›Ð˜ÐšÐžÐ‘Ð Ð˜Ð¢ÐÐÐ†Ð¯": [(1000, None), (100, 275), (20, 300), (10, 325), (4, 350), (2, 375), (1, 450)],
    "ÐÐ†Ð”Ð•Ð Ð›ÐÐÐ”Ð˜":     [(20, 700), (4, 750), (1, 800)],
    "ÐÐ†ÐœÐ•Ð§Ð§Ð˜ÐÐ":      [(10, 900), (4, 1000), (1, 1100)],
    "Ð¤Ð ÐÐÐ¦Ð†Ð¯":        [(10, 1100), (4, 1200), (1, 1400)],
    "Ð†Ð¡ÐŸÐÐÐ†Ð¯":        [(10, 1000), (4, 1100), (1, 1200)],
    "Ð§Ð•Ð¥Ð†Ð¯":          [(10, 650), (4, 700), (1, 750)],
    "ÐŸÐžÐ›Ð¬Ð©Ð":         [(10, 400), (4, 450), (1, 500)],
    "Ð›Ð˜Ð¢Ð’Ð":          [(10, 650), (4, 700), (1, 750)],
    "Ð›ÐÐ¢Ð’Ð†Ð¯":         [(10, 650), (4, 700), (1, 750)],
    "ÐšÐÐ—ÐÐ¥Ð¡Ð¢ÐÐ":      [(10, 1100), (4, 1200), (2, 1300), (1, 1500)],
    "ÐœÐÐ ÐžÐšÐšÐž":        [(10, 750), (4, 800), (2, 900), (1, 1000)],
}

FLAGS = {
    "Ð’Ð•Ð›Ð˜ÐšÐžÐ‘Ð Ð˜Ð¢ÐÐÐ†Ð¯": "ðŸ‡¬ðŸ‡§", "ÐÐ†Ð”Ð•Ð Ð›ÐÐÐ”Ð˜": "ðŸ‡³ðŸ‡±", "ÐÐ†ÐœÐ•Ð§Ð§Ð˜ÐÐ": "ðŸ‡©ðŸ‡ª",
    "Ð¤Ð ÐÐÐ¦Ð†Ð¯": "ðŸ‡«ðŸ‡·", "Ð†Ð¡ÐŸÐÐÐ†Ð¯": "ðŸ‡ªðŸ‡¸", "Ð§Ð•Ð¥Ð†Ð¯": "ðŸ‡¨ðŸ‡¿",
    "ÐŸÐžÐ›Ð¬Ð©Ð": "ðŸ‡µðŸ‡±", "Ð›Ð˜Ð¢Ð’Ð": "ðŸ‡±ðŸ‡¹", "Ð›ÐÐ¢Ð’Ð†Ð¯": "ðŸ‡±ðŸ‡»",
    "ÐšÐÐ—ÐÐ¥Ð¡Ð¢ÐÐ": "ðŸ‡°ðŸ‡¿", "ÐœÐÐ ÐžÐšÐšÐž": "ðŸ‡²ðŸ‡¦", "Ð†Ð¢ÐÐ›Ð†Ð¯": "ðŸ‡®ðŸ‡¹", "ÐœÐžÐ›Ð”ÐžÐ’Ð": "ðŸ‡²ðŸ‡©",
}

DISPLAY = {
    "Ð’Ð•Ð›Ð˜ÐšÐžÐ‘Ð Ð˜Ð¢ÐÐÐ†Ð¯": "ÐÐ½Ð³Ð»Ñ–Ñ", "ÐÐ†Ð”Ð•Ð Ð›ÐÐÐ”Ð˜": "ÐÑ–Ð´ÐµÑ€Ð»Ð°Ð½Ð´Ð¸", "ÐÐ†ÐœÐ•Ð§Ð§Ð˜ÐÐ": "ÐÑ–Ð¼ÐµÑ‡Ñ‡Ð¸Ð½Ð°",
    "Ð¤Ð ÐÐÐ¦Ð†Ð¯": "Ð¤Ñ€Ð°Ð½Ñ†Ñ–Ñ", "Ð†Ð¡ÐŸÐÐÐ†Ð¯": "Ð†ÑÐ¿Ð°Ð½Ñ–Ñ", "Ð§Ð•Ð¥Ð†Ð¯": "Ð§ÐµÑ…Ñ–Ñ",
    "ÐŸÐžÐ›Ð¬Ð©Ð": "ÐŸÐ¾Ð»ÑŒÑ‰Ð°", "Ð›Ð˜Ð¢Ð’Ð": "Ð›Ð¸Ñ‚Ð²Ð°", "Ð›ÐÐ¢Ð’Ð†Ð¯": "Ð›Ð°Ñ‚Ð²Ñ–Ñ",
    "ÐšÐÐ—ÐÐ¥Ð¡Ð¢ÐÐ": "ÐšÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½", "ÐœÐÐ ÐžÐšÐšÐž": "ÐœÐ°Ñ€Ð¾ÐºÐºÐ¾", "Ð†Ð¢ÐÐ›Ð†Ð¯": "Ð†Ñ‚Ð°Ð»Ñ–Ñ", "ÐœÐžÐ›Ð”ÐžÐ’Ð": "ÐœÐ¾Ð»Ð´Ð¾Ð²Ð°",
}

DIAL_CODES = {
    "Ð’Ð•Ð›Ð˜ÐšÐžÐ‘Ð Ð˜Ð¢ÐÐÐ†Ð¯": "+44", "Ð†Ð¡ÐŸÐÐÐ†Ð¯": "+34", "Ð¤Ð ÐÐÐ¦Ð†Ð¯": "+33",
    "ÐÐ†ÐœÐ•Ð§Ð§Ð˜ÐA": "+49", "ÐÐ†Ð”Ð•Ð Ð›ÐÐÐ”Ð˜": "+31", "Ð†Ð¢ÐÐ›Ð†Ð¯": "+39",
    "Ð§Ð•Ð¥Ð†Ð¯": "+420", "ÐœÐžÐ›Ð”ÐžÐ’Ð": "+373", "ÐšÐÐ—ÐÐ¥Ð¡Ð¢ÐÐ": "+7", "Ð›ÐÐ¢Ð’Ð†Ð¯": "+371",
}

# ==== ÐÐÐ¯Ð’ÐÐ†Ð¡Ð¢Ð¬ ÐšÐ ÐÐ‡Ð =====
COUNTRY_AVAILABILITY = {
    "Ð’Ð•Ð›Ð˜ÐšÐžÐ‘Ð Ð˜Ð¢ÐÐÐ†Ð¯": {"status": "+", "reason": ""},
    "ÐÐ†Ð”Ð•Ð Ð›ÐÐÐ”Ð˜":     {"status": "+", "reason": ""},
    "ÐÐ†ÐœÐ•Ð§Ð§Ð˜ÐÐ":       {"status": "+", "reason": ""},
    "Ð¤Ð ÐÐÐ¦Ð†Ð¯":         {"status": "+", "reason": ""},
    "Ð†Ð¡ÐŸÐÐÐ†Ð¯":         {"status": "+", "reason": ""},
    "Ð§Ð•Ð¥Ð†Ð¯":           {"status": "+", "reason": ""},
    "ÐŸÐžÐ›Ð¬Ð©Ð":          {"status": "+", "reason": ""},
    "Ð›Ð˜Ð¢Ð’Ð":           {"status": "-", "reason": "ÐÐ°Ñ€Ð°Ð· ÑÑ–Ð¼-ÐºÐ°Ñ€Ñ‚Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ– Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ Ð· Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ñ–Ñ”ÑŽ."},
    "Ð›ÐÐ¢Ð’Ð†Ð¯":          {"status": "-", "reason": "ÐÐ°Ñ€Ð°Ð· ÑÑ–Ð¼-ÐºÐ°Ñ€Ñ‚Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ– Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ Ð· Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ñ–Ñ”ÑŽ."},
    "ÐšÐÐ—ÐÐ¥Ð¡Ð¢ÐÐ":       {"status": "+", "reason": ""},
    "ÐœÐÐ ÐžÐšÐšÐž":         {"status": "+", "reason": ""},
}

USSD_DATA = {
    "Ð’Ð•Ð›Ð˜ÐšÐžÐ‘Ð Ð˜Ð¢ÐÐÐ†Ð¯": [("Vodafone", "*#100#")],
    "Ð†Ð¡ÐŸÐÐÐ†Ð¯": [("Lebara", "*321#"), ("Movistar", "*133#"), ("Lycamobile", "*321#")],
    "ÐÐ†ÐœÐ•Ð§Ð§Ð˜ÐÐ": [("Vodafone", "*135#"), ("Lebara", "*135#"), ("Lycamobile", "*132#")],
    "ÐÐ†Ð”Ð•Ð Ð›ÐÐÐ”Ð˜": [("Lycamobile", "*102#")],
    "Ð†Ð¢ÐÐ›Ð†Ð¯": [("Lycamobile", "*132#")],
    "Ð¤Ð ÐÐÐ¦Ð†Ð¯": [("Lebara", "*144*1#")],
    "Ð§Ð•Ð¥Ð†Ð¯": [("T-mobile", "*101#"), ("Kaktus", "*103#")],
    "ÐœÐžÐ›Ð”ÐžÐ’Ð": [(None, "*444# (Ð¿Ð¾Ñ‚Ñ–Ð¼ 3)")],
    "ÐšÐÐ—ÐÐ¥Ð¡Ð¢ÐÐ": [(None, "*120#")],
    "Ð›ÐÐ¢Ð’Ð†Ð¯": [(None, "ÐšÐ¸Ð½ÑŒÑ‚Ðµ Ð²Ð¸ÐºÐ»Ð¸Ðº Ð½Ð° ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€ â€” Ð²Ð°Ñˆ Ð»Ð°Ñ‚Ð²Ñ–Ð¹ÑÑŒÐºÐ¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ð²Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð·Ð¸Ñ‚ÑŒÑÑ Ñƒ Ð²Ð¸ÐºÐ»Ð¸ÐºÑƒ/Ð½Ð° ÐµÐºÑ€Ð°Ð½Ñ–.")],
}

def get_availability(country_norm: str) -> Tuple[str, Optional[str]]:
    config = COUNTRY_AVAILABILITY.get(country_norm)
    if not config: return ("+", None)
    return (config.get("status", "+"), config.get("reason", "").strip() or None)
