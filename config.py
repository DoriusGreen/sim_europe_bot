import os
from typing import Set, Tuple, Optional

# ===== –ö–ª—é—á—ñ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è =====
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
PORT = int(os.getenv("PORT", "8443"))

# ==== –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –ø–∞–º'—è—Ç—ñ/–º—ñ—Ç–æ–∫ ====
MAX_TURNS = 10
ORDER_DUP_WINDOW_SEC = 20 * 60  # 20 —Ö–≤–∏–ª–∏–Ω

# ==== –ì–†–£–ü–ê –î–õ–Ø –ó–ê–ú–û–í–õ–ï–ù–¨ ====
ORDER_FORWARD_CHAT_ID = int(os.getenv("ORDER_FORWARD_CHAT_ID", "-1003062477534"))

# ==== –ú–µ–Ω–µ–¥–∂–µ—Ä–∏ ====
def _parse_ids(env: Optional[str]) -> Set[int]:
    out: Set[int] = set()
    if not env: return out
    for x in env.split(","):
        try:
            if x.strip(): out.add(int(x.strip()))
        except ValueError: pass
    return out

def _parse_usernames(env: Optional[str]) -> Set[str]:
    out: Set[str] = set()
    if not env: return out
    for x in env.split(","):
        x = x.strip().lstrip("@").lower()
        if x: out.add(x)
    return out

DEFAULT_OWNER_USERNAME = os.getenv("OWNER_USERNAME", "Sim_Card_Three")
DEFAULT_OWNER_USER_ID = os.getenv("OWNER_USER_ID", "")

MANAGER_USER_IDS = _parse_ids(os.getenv("MANAGER_USER_IDS"))
if DEFAULT_OWNER_USER_ID:
    MANAGER_USER_IDS |= _parse_ids(DEFAULT_OWNER_USER_ID)

MANAGER_USERNAMES = _parse_usernames(os.getenv("MANAGER_USERNAMES"))
if DEFAULT_OWNER_USERNAME:
    MANAGER_USERNAMES.add(DEFAULT_OWNER_USERNAME.strip().lstrip("@").lower())

# ==== –ü—Ä–∞–π—Å–∏ –π –º–∞–ø–∏ –∫—Ä–∞—ó–Ω ====
PRICE_TIERS = {
    "–í–ï–õ–ò–ö–û–ë–†–ò–¢–ê–ù–Ü–Ø": [(1000, None), (100, 275), (20, 300), (10, 325), (4, 350), (2, 375), (1, 450)],
    "–ù–Ü–î–ï–†–õ–ê–ù–î–ò":     [(20, 850), (4, 900), (1, 950)],
    "–ù–Ü–ú–ï–ß–ß–ò–ù–ê":      [(10, 1100), (4, 1200), (1, 1300)],
    "–§–†–ê–ù–¶–Ü–Ø":        [(10, 1100), (4, 1200), (1, 1400)],
    "–Ü–°–ü–ê–ù–Ü–Ø":        [(10, 1500), (4, 1800), (1, 2000)],
    "–ß–ï–•–Ü–Ø":          [(10, 650), (4, 700), (1, 750)],
    "–ü–û–õ–¨–©–ê":         [(10, 400), (4, 450), (1, 500)],
    "–õ–ò–¢–í–ê":          [(10, 650), (4, 700), (1, 750)],
    "–õ–ê–¢–í–Ü–Ø":         [(10, 650), (4, 700), (1, 750)],
    "–ö–ê–ó–ê–•–°–¢–ê–ù":      [(10, 1100), (4, 1200), (2, 1300), (1, 1500)],
    "–ú–ê–†–û–ö–ö–û":        [(10, 750), (4, 800), (2, 900), (1, 1000)],
}

FLAGS = {
    "–í–ï–õ–ò–ö–û–ë–†–ò–¢–ê–ù–Ü–Ø": "üá¨üáß", "–ù–Ü–î–ï–†–õ–ê–ù–î–ò": "üá≥üá±", "–ù–Ü–ú–ï–ß–ß–ò–ù–ê": "üá©üá™",
    "–§–†–ê–ù–¶–Ü–Ø": "üá´üá∑", "–Ü–°–ü–ê–ù–Ü–Ø": "üá™üá∏", "–ß–ï–•–Ü–Ø": "üá®üáø",
    "–ü–û–õ–¨–©–ê": "üáµüá±", "–õ–ò–¢–í–ê": "üá±üáπ", "–õ–ê–¢–í–Ü–Ø": "üá±üáª",
    "–ö–ê–ó–ê–•–°–¢–ê–ù": "üá∞üáø", "–ú–ê–†–û–ö–ö–û": "üá≤üá¶", "–Ü–¢–ê–õ–Ü–Ø": "üáÆüáπ", "–ú–û–õ–î–û–í–ê": "üá≤üá©",
}

DISPLAY = {
    "–í–ï–õ–ò–ö–û–ë–†–ò–¢–ê–ù–Ü–Ø": "–ê–Ω–≥–ª—ñ—è", "–ù–Ü–î–ï–†–õ–ê–ù–î–ò": "–ù—ñ–¥–µ—Ä–ª–∞–Ω–¥–∏", "–ù–Ü–ú–ï–ß–ß–ò–ù–ê": "–ù—ñ–º–µ—á—á–∏–Ω–∞",
    "–§–†–ê–ù–¶–Ü–Ø": "–§—Ä–∞–Ω—Ü—ñ—è", "–Ü–°–ü–ê–ù–Ü–Ø": "–Ü—Å–ø–∞–Ω—ñ—è", "–ß–ï–•–Ü–Ø": "–ß–µ—Ö—ñ—è",
    "–ü–û–õ–¨–©–ê": "–ü–æ–ª—å—â–∞", "–õ–ò–¢–í–ê": "–õ–∏—Ç–≤–∞", "–õ–ê–¢–í–Ü–Ø": "–õ–∞—Ç–≤—ñ—è",
    "–ö–ê–ó–ê–•–°–¢–ê–ù": "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", "–ú–ê–†–û–ö–ö–û": "–ú–∞—Ä–æ–∫–∫–æ", "–Ü–¢–ê–õ–Ü–Ø": "–Ü—Ç–∞–ª—ñ—è", "–ú–û–õ–î–û–í–ê": "–ú–æ–ª–¥–æ–≤–∞",
}

DIAL_CODES = {
    "–í–ï–õ–ò–ö–û–ë–†–ò–¢–ê–ù–Ü–Ø": "+44", "–Ü–°–ü–ê–ù–Ü–Ø": "+34", "–§–†–ê–ù–¶–Ü–Ø": "+33",
    "–ù–Ü–ú–ï–ß–ß–ò–ù–ê": "+49", "–ù–Ü–î–ï–†–õ–ê–ù–î–ò": "+31", "–Ü–¢–ê–õ–Ü–Ø": "+39",
    "–ß–ï–•–Ü–Ø": "+420", "–ú–û–õ–î–û–í–ê": "+373", "–ö–ê–ó–ê–•–°–¢–ê–ù": "+7", "–õ–ê–¢–í–Ü–Ø": "+371",
}

# ==== –ù–ê–Ø–í–ù–Ü–°–¢–¨ –ö–†–ê–á–ù =====
COUNTRY_AVAILABILITY = {
    "–í–ï–õ–ò–ö–û–ë–†–ò–¢–ê–ù–Ü–Ø": {"status": "+", "reason": ""},
    "–ù–Ü–î–ï–†–õ–ê–ù–î–ò":     {"status": "+", "reason": ""},
    "–ù–Ü–ú–ï–ß–ß–ò–ù–ê":       {"status": "+", "reason": ""},
    "–§–†–ê–ù–¶–Ü–Ø":         {"status": "+", "reason": ""},
    "–Ü–°–ü–ê–ù–Ü–Ø":         {"status": "+", "reason": ""},
    "–ß–ï–•–Ü–Ø":           {"status": "+", "reason": ""},
    "–ü–û–õ–¨–©–ê":          {"status": "+", "reason": ""},
    "–õ–ò–¢–í–ê":           {"status": "-", "reason": "–ù–∞—Ä–∞–∑ —Å—ñ–º-–∫–∞—Ä—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É –∑ –∞–∫—Ç–∏–≤–∞—Ü—ñ—î—é."},
    "–õ–ê–¢–í–Ü–Ø":          {"status": "-", "reason": "–ù–∞—Ä–∞–∑ —Å—ñ–º-–∫–∞—Ä—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É –∑ –∞–∫—Ç–∏–≤–∞—Ü—ñ—î—é."},
    "–ö–ê–ó–ê–•–°–¢–ê–ù":       {"status": "+", "reason": ""},
    "–ú–ê–†–û–ö–ö–û":         {"status": "+", "reason": ""},
}

USSD_DATA = {
    "–í–ï–õ–ò–ö–û–ë–†–ò–¢–ê–ù–Ü–Ø": [("Vodafone", "*#100#")],
    "–Ü–°–ü–ê–ù–Ü–Ø": [("Lebara", "*321#"), ("Movistar", "*133#"), ("Lycamobile", "*321#")],
    "–ù–Ü–ú–ï–ß–ß–ò–ù–ê": [("Vodafone", "*135#"), ("Lebara", "*135#"), ("Lycamobile", "*132#")],
    "–ù–Ü–î–ï–†–õ–ê–ù–î–ò": [("Lycamobile", "*102#")],
    "–Ü–¢–ê–õ–Ü–Ø": [("Lycamobile", "*132#")],
    "–§–†–ê–ù–¶–Ü–Ø": [("Lebara", "*144*1#")],
    "–ß–ï–•–Ü–Ø": [("T-mobile", "*101#"), ("Kaktus", "*103#")],
    "–ú–û–õ–î–û–í–ê": [(None, "*444# (–ø–æ—Ç—ñ–º 3)")],
    "–ö–ê–ó–ê–•–°–¢–ê–ù": [(None, "*120#")],
    "–õ–ê–¢–í–Ü–Ø": [(None, "–ö–∏–Ω—å—Ç–µ –≤–∏–∫–ª–∏–∫ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –Ω–æ–º–µ—Ä ‚Äî –≤–∞—à –ª–∞—Ç–≤—ñ–π—Å—å–∫–∏–π –Ω–æ–º–µ—Ä –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç—å—Å—è —É –≤–∏–∫–ª–∏–∫—É/–Ω–∞ –µ–∫—Ä–∞–Ω—ñ.")],
}

def get_availability(country_norm: str) -> Tuple[str, Optional[str]]:
    entry = COUNTRY_AVAILABILITY.get(country_norm)
    if not entry: return ("+", None)
    return (entry.get("status", "+"), entry.get("reason", "").strip() or None)

# ==== –ö–û–î–ò –î–õ–Ø –ê–í–¢–û-–í–Ü–î–ü–û–í–Ü–î–Ü –ü–Ü–°–õ–Ø –ó–ê–ú–û–í–õ–ï–ù–ù–Ø ====
POST_ORDER_USSD = {
    "–í–ï–õ–ò–ö–û–ë–†–ò–¢–ê–ù–Ü–Ø": "*#100#",
    "–ù–Ü–ú–ï–ß–ß–ò–ù–ê": "*135#",
    "–§–†–ê–ù–¶–Ü–Ø": "*144*1#",
    "–Ü–°–ü–ê–ù–Ü–Ø": "*321#",
    "–ö–ê–ó–ê–•–°–¢–ê–ù": "*120#",
    "–ú–û–õ–î–û–í–ê": "*444#",
}

# ==== –†–ï–ö–õ–ê–ú–ù–ï –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø (PROMO) ====
PROMO_TEXT = (
    "üî• <b>–•–æ—á–µ—à –ø—ñ–¥–ø–∞–ª–∏—Ç–∏ –†–æ—Å—ñ—é? –¢–µ–ø–µ—Ä –º–æ–∂–µ—à!</b>\n\n"
    "–î–æ–ª—É—á–∞–π—Ç–µ—Å—å –¥–æ –Ω–∞—à–æ–≥–æ —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–ª–∞–≥–æ–¥—ñ–π–Ω–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É –Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫—É 40-—ó –û–ê–ë—Ä —ñ–º. –í–µ–ª–∏–∫–æ–≥–æ –∫–Ω—è–∑—è –í—ñ—Ç–æ–≤—Ç–∞.\n\n"
    "üî• –í–ø–∏—à—ñ—Ç—å —Å–≤–æ—î —ñ–º'—è –≤ —ñ—Å—Ç–æ—Ä—ñ—é –ø–∞–ª—ñ—ó–≤ –†–æ—Å—ñ—ó!\n\n"
    "burnmoscow.com"
)
